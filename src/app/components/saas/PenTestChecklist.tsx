/**
 * PenTestChecklist
 * ─────────────────────────────────────────────────────────────────────────────
 * Interactive penetration test checklist for Super Admins.
 * Covers all Phase 1–6 endpoints: authentication, RBAC, CSRF/HMAC, rate
 * limiting, session management, encryption at rest, input validation,
 * compliance endpoints, and API security.
 *
 * State is persisted in localStorage so progress survives page refreshes.
 * Server-side persistence (KV store) enables cross-device sync between Super Admins.
 * CSV export is available for handoff to external auditors.
 */

import { useState, useMemo, useCallback, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'motion/react';
import {
  Download, ShieldCheck, CheckCircle2, XCircle, AlertTriangle,
  HelpCircle, ChevronDown, ChevronRight, Filter,
  RotateCcw, Search, Info, Clock, CloudUpload, Cloud, Loader2, RefreshCw,
} from 'lucide-react';
import { toast } from 'sonner';
import { Card, PrimaryBtn } from './SaasLayout';
import { useDashboardTheme } from './DashboardThemeContext';
import {
  fetchPenTestResults,
  savePenTestResults,
  type PenTestResultEntry,
} from '../../utils/apiClient';

// ── Emergency save helpers ────────────────────────────────────────────────────
// Used by the beforeunload handler to fire a best-effort keepalive request.
// We pre-cache auth headers on every successful server interaction so the
// synchronous beforeunload handler can use them without awaiting.
import { projectId } from '/utils/supabase/info';
const PENTEST_SAVE_URL = `https://${projectId}.supabase.co/functions/v1/make-server-309fe679/compliance/pentest-results`;

// ── Types ────────────────────────────────────────────────────────────────────

type TestStatus = 'not_tested' | 'pass' | 'fail' | 'partial' | 'na';
type Severity = 'critical' | 'high' | 'medium' | 'low' | 'info';

interface TestItem {
  id: string;
  title: string;
  description: string;
  endpoints: string[];
  expectedBehavior: string;
  severity: Severity;
  isoRef?: string;   // ISO 27001 control reference
  pdpaRef?: string;  // PDPA / POPIA / DPA reference
}

interface TestCategory {
  id: string;
  title: string;
  description: string;
  items: TestItem[];
}

interface TestResult {
  status: TestStatus;
  notes: string;
  testedAt?: string;
  tester?: string;
}

// ─── Persistence ──────────────────────────────────────────────────────────────

const LS_KEY = 'btl_pentest_results';
const LS_EMERGENCY_SAVE_KEY = 'btl_pentest_emergency_save';

function loadResults(): Record<string, TestResult> {
  try {
    const raw = localStorage.getItem(LS_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch { return {}; }
}

function saveResults(results: Record<string, TestResult>) {
  localStorage.setItem(LS_KEY, JSON.stringify(results));
}

// ─── Test Data (comprehensive coverage of all Phase 1–6 endpoints) ────────────

const CATEGORIES: TestCategory[] = [
  {
    id: 'auth',
    title: 'Authentication & Login',
    description: 'Verify authentication flows including password, MFA, magic link, session management, and hCaptcha',
    items: [
      { id: 'auth-01', title: 'Valid login with correct credentials', description: 'Attempt login with valid email/password. Verify session token is returned and user is redirected to the correct dashboard based on role.', endpoints: ['POST /auth/login', 'supabase.auth.signInWithPassword'], expectedBehavior: '200 OK with session token; redirect to role-appropriate route', severity: 'critical', isoRef: 'A.9.4.2' },
      { id: 'auth-02', title: 'Invalid credentials rejection', description: 'Attempt login with incorrect password. Verify generic error message (no username enumeration).', endpoints: ['POST /auth/login'], expectedBehavior: '401 with "Invalid email or password" — no distinction between wrong email vs wrong password', severity: 'critical', isoRef: 'A.9.4.2' },
      { id: 'auth-03', title: 'MFA TOTP enforcement for SUPER_ADMIN', description: 'Login as SUPER_ADMIN and verify MFA challenge is required before session is granted.', endpoints: ['supabase.auth.mfa.listFactors', 'supabase.auth.mfa.challengeAndVerify'], expectedBehavior: 'MFA challenge modal appears; session only granted after valid TOTP code', severity: 'critical', isoRef: 'A.9.4.2' },
      { id: 'auth-04', title: 'MFA TOTP enforcement for TENANT_ADMIN (policy-based)', description: 'Verify TENANT_ADMIN MFA enforcement respects the tenant MFA policy setting from GET /mfa/policy.', endpoints: ['GET /mfa/policy'], expectedBehavior: 'If requireTenantAdminMfa=true, MFA challenge is shown; otherwise direct login', severity: 'high', isoRef: 'A.9.4.2' },
      { id: 'auth-05', title: 'hCaptcha enforcement on login', description: 'Verify login form triggers hCaptcha challenge and token is submitted with the auth request.', endpoints: ['POST /auth/login'], expectedBehavior: 'Login request includes captchaToken; without it, auth fails', severity: 'high' },
      { id: 'auth-06', title: 'Magic link OTP delivery', description: 'Request a magic link via the Magic Link tab. Verify OTP email is sent.', endpoints: ['supabase.auth.signInWithOtp'], expectedBehavior: 'Magic link email delivered; clicking it authenticates the user', severity: 'medium' },
      { id: 'auth-07', title: 'Expired magic link / invite handling', description: 'Attempt to use an expired or already-used invite link. Verify friendly error message.', endpoints: ['GET /auth/callback'], expectedBehavior: 'Redirect to /login with otp_expired error fragment; "Invite link expired" message displayed', severity: 'medium', isoRef: 'A.9.4.2' },
      { id: 'auth-08', title: 'Password reset flow', description: 'Request password reset via POST /auth/reset-password. Verify email delivery and link validity.', endpoints: ['POST /auth/reset-password'], expectedBehavior: '200 OK; reset email sent; link allows password change', severity: 'high' },
      { id: 'auth-09', title: 'Session expiry and re-authentication', description: 'Let a session expire (or simulate via token manipulation). Verify automatic redirect to /login?reason=session_expired.', endpoints: ['All authenticated routes'], expectedBehavior: 'Expired session redirects to login with toast message', severity: 'high', isoRef: 'A.9.4.2' },
      { id: 'auth-10', title: 'Remember me functionality', description: 'Toggle "Remember me" and verify email is persisted/cleared in localStorage.', endpoints: ['Client-side'], expectedBehavior: 'bt_remembered_email key set/removed in localStorage correctly', severity: 'low' },
    ],
  },
  {
    id: 'rbac',
    title: 'Role-Based Access Control (RBAC)',
    description: 'Verify authorization boundaries: SUPER_ADMIN, TENANT_ADMIN, EMPLOYEE',
    items: [
      { id: 'rbac-01', title: 'SUPER_ADMIN exclusive routes', description: 'Attempt to access /super/* routes as TENANT_ADMIN or EMPLOYEE. Verify 403 response.', endpoints: ['GET /compliance-status', 'GET /tenants', 'POST /tenants', 'GET /audit-logs'], expectedBehavior: '403 Forbidden with ROLE_DENIED security event logged', severity: 'critical', isoRef: 'A.9.2.3' },
      { id: 'rbac-02', title: 'TENANT_ADMIN cannot access other tenants', description: 'As TENANT_ADMIN of tenant A, attempt to access data for tenant B.', endpoints: ['GET /tenant-users?tenantId=<other>', 'GET /social-accounts?tenantId=<other>'], expectedBehavior: '403 Forbidden with TENANT_MISMATCH security event logged', severity: 'critical', isoRef: 'A.9.2.3' },
      { id: 'rbac-03', title: 'EMPLOYEE cannot access admin routes', description: 'As EMPLOYEE, attempt to access tenant admin routes (user management, billing, etc).', endpoints: ['GET /tenant-users', 'POST /invite-user', 'PUT /tenant-settings'], expectedBehavior: '403 Forbidden', severity: 'critical', isoRef: 'A.9.2.3' },
      { id: 'rbac-04', title: 'Tenant scoping on content operations', description: 'Verify all content CRUD operations enforce tenantId scoping via requireTenantScope().', endpoints: ['POST /content', 'PUT /content/:id', 'DELETE /content/:id'], expectedBehavior: 'Operations only succeed for content owned by the authenticated user\'s tenant', severity: 'high', isoRef: 'A.9.2.3' },
      { id: 'rbac-05', title: 'Approval flow role enforcement', description: 'Verify only TENANT_ADMIN can approve/reject content; EMPLOYEE can only submit for review.', endpoints: ['POST /content/:id/approve', 'POST /content/:id/reject'], expectedBehavior: 'EMPLOYEE gets 403; TENANT_ADMIN succeeds', severity: 'high', isoRef: 'A.9.2.3' },
    ],
  },
  {
    id: 'csrf-hmac',
    title: 'CSRF & HMAC Request Signing',
    description: 'Verify CSRF token validation and HMAC request signature integrity on all mutating endpoints',
    items: [
      { id: 'csrf-01', title: 'CSRF token required on POST/PUT/DELETE', description: 'Send a mutating request without X-CSRF-Token header. Verify rejection (or soft-mode logging).', endpoints: ['All POST/PUT/DELETE endpoints'], expectedBehavior: 'In enforce mode: 403 CSRF_INVALID. In soft mode: request proceeds but CSRF_INVALID event logged', severity: 'critical', isoRef: 'A.14.1.2' },
      { id: 'csrf-02', title: 'CSRF token rotation', description: 'Verify CSRF token changes per session and expired tokens are rejected.', endpoints: ['GET /csrf-token'], expectedBehavior: 'Fresh token on each request; replayed tokens from different sessions fail', severity: 'high', isoRef: 'A.14.1.2' },
      { id: 'csrf-03', title: 'HMAC signature on signed requests', description: 'Send a request via signedApi() and verify X-Request-Signature header is present and validated server-side.', endpoints: ['All signedApi() routes'], expectedBehavior: 'Valid HMAC passes; tampered body or missing signature logged as HMAC_INVALID', severity: 'high', isoRef: 'A.14.1.2' },
      { id: 'csrf-04', title: 'HMAC signature tampering detection', description: 'Modify the request body after HMAC signing. Verify server rejects the tampered request.', endpoints: ['POST /content', 'PUT /content/:id'], expectedBehavior: 'HMAC_INVALID security event logged; in enforce mode, 403 returned', severity: 'critical', isoRef: 'A.14.1.2' },
      { id: 'csrf-05', title: 'Enforcement mode toggle (CSRF_ENFORCEMENT / HMAC_ENFORCEMENT)', description: 'Verify the _enforcementMode variable correctly reads from env vars and toggles between soft/enforce modes.', endpoints: ['Server startup'], expectedBehavior: 'Soft mode: log only. Enforce mode: reject invalid requests', severity: 'medium' },
    ],
  },
  {
    id: 'rate-limit',
    title: 'Rate Limiting',
    description: 'Verify rate limiting protects against brute force and abuse on all sensitive endpoints',
    items: [
      { id: 'rl-01', title: 'Login rate limiting', description: 'Attempt rapid successive login requests. Verify rate limiter kicks in.', endpoints: ['POST /auth/login'], expectedBehavior: '429 Too Many Requests after threshold; RATE_LIMITED security event logged', severity: 'high', isoRef: 'A.9.4.2' },
      { id: 'rl-02', title: 'Signup/request-access rate limiting', description: 'Rapidly submit access requests. Verify throttling.', endpoints: ['POST /signup', 'POST /request-access'], expectedBehavior: '429 after threshold', severity: 'medium' },
      { id: 'rl-03', title: 'Password reset rate limiting', description: 'Rapidly request password resets for the same email.', endpoints: ['POST /auth/reset-password'], expectedBehavior: '429 after threshold; prevents email flooding', severity: 'high' },
      { id: 'rl-04', title: 'Integrity check rate limiting', description: 'Rapidly trigger manual integrity checks.', endpoints: ['POST /compliance/run-integrity-check'], expectedBehavior: '429 after 1 request per 60 seconds', severity: 'medium' },
      { id: 'rl-05', title: 'API endpoint general rate limiting', description: 'Verify all endpoints have reasonable rate limits applied via rateLimit() middleware.', endpoints: ['All endpoints'], expectedBehavior: 'Excessive requests return 429', severity: 'medium' },
    ],
  },
  {
    id: 'session',
    title: 'Session Management',
    description: 'Verify session freshness, token validation, and secure session lifecycle',
    items: [
      { id: 'sess-01', title: 'Session freshness validation', description: 'Verify validateSessionFreshness() rejects tokens older than the configured threshold.', endpoints: ['All authenticated endpoints'], expectedBehavior: 'Stale tokens return 401 with SESSION_EXPIRED event', severity: 'high', isoRef: 'A.9.4.2' },
      { id: 'sess-02', title: 'Token manipulation detection', description: 'Modify JWT payload (e.g. change role claim) and submit. Verify server detects tampering.', endpoints: ['All authenticated endpoints'], expectedBehavior: 'Modified tokens fail Supabase verification; 401 returned', severity: 'critical', isoRef: 'A.9.4.2' },
      { id: 'sess-03', title: 'Concurrent session handling', description: 'Login from two different browsers/devices. Verify both sessions work independently.', endpoints: ['All authenticated endpoints'], expectedBehavior: 'Both sessions valid; sign out from one doesn\'t invalidate the other (unless policy configured)', severity: 'medium' },
      { id: 'sess-04', title: 'Sign-out session invalidation', description: 'Sign out and attempt to reuse the old access token.', endpoints: ['supabase.auth.signOut'], expectedBehavior: 'Old token returns 401 on subsequent requests', severity: 'high', isoRef: 'A.9.4.2' },
    ],
  },
  {
    id: 'encryption',
    title: 'Encryption at Rest (Phase 3)',
    description: 'Verify AES-256-GCM encryption of sensitive data and backward compatibility',
    items: [
      { id: 'enc-01', title: 'SMTP password encrypted at rest', description: 'Save SMTP settings and verify the password is stored with enc:v1: prefix in KV store.', endpoints: ['PUT /smtp-config'], expectedBehavior: 'Password value in KV starts with "enc:v1:" — never stored as plaintext', severity: 'critical', isoRef: 'A.10.1.1', pdpaRef: 'PDPA s.9' },
      { id: 'enc-02', title: 'OAuth tokens encrypted at rest', description: 'Connect a social account and verify tokens are encrypted in storage.', endpoints: ['POST /social-accounts/connect'], expectedBehavior: 'accessToken and refreshToken stored with enc:v1: prefix', severity: 'critical', isoRef: 'A.10.1.1' },
      { id: 'enc-03', title: 'Backward compatibility — plaintext decrypt()', description: 'Verify decrypt() returns plaintext values unchanged when they lack the enc:v1: prefix.', endpoints: ['crypto.tsx decrypt()'], expectedBehavior: 'Pre-existing plaintext values are returned as-is (no error)', severity: 'high' },
      { id: 'enc-04', title: 'ENCRYPTION_SECRET key derivation', description: 'Verify the encryption key is derived from ENCRYPTION_SECRET env var and not hardcoded.', endpoints: ['crypto.tsx'], expectedBehavior: 'Missing ENCRYPTION_SECRET causes graceful fallback or clear error', severity: 'critical', isoRef: 'A.10.1.2' },
    ],
  },
  {
    id: 'input-val',
    title: 'Input Validation & Sanitization (Phase 3)',
    description: 'Verify server-side sanitization prevents XSS, injection, and malformed data',
    items: [
      { id: 'iv-01', title: 'XSS in content fields', description: 'Submit content with <script> tags, event handlers (onerror, onclick), and encoded payloads.', endpoints: ['POST /content', 'PUT /content/:id'], expectedBehavior: 'HTML tags stripped by sanitizeString(); only safe text persisted', severity: 'critical', isoRef: 'A.14.2.5' },
      { id: 'iv-02', title: 'SQL injection via search/filter params', description: 'Pass SQL fragments in query parameters (e.g. " OR 1=1 --).', endpoints: ['GET /content?search=...', 'GET /audit-logs?action=...'], expectedBehavior: 'Parameterized queries prevent injection; malicious input treated as literal string', severity: 'critical' },
      { id: 'iv-03', title: 'Email validation', description: 'Submit invalid email formats in signup, invite, and alert recipient forms.', endpoints: ['POST /signup', 'POST /invite-user', 'PUT /compliance/alert-recipients'], expectedBehavior: '400 Bad Request with "Invalid email" error', severity: 'medium' },
      { id: 'iv-04', title: 'UUID validation on resource IDs', description: 'Pass non-UUID strings as resource identifiers.', endpoints: ['GET /content/:id', 'DELETE /content/:id'], expectedBehavior: '400 Bad Request with "Invalid UUID" error', severity: 'medium' },
      { id: 'iv-05', title: 'sanitizeObject() on nested payloads', description: 'Submit deeply nested objects with XSS payloads at various levels.', endpoints: ['POST /content', 'PUT /tenant-settings'], expectedBehavior: 'All string values at all nesting levels are sanitized', severity: 'high' },
    ],
  },
  {
    id: 'compliance',
    title: 'Compliance Endpoints (Phase 6)',
    description: 'Verify audit logging, integrity checks, data retention, and alert recipient management',
    items: [
      { id: 'comp-01', title: 'Security audit log event persistence', description: 'Perform various security-relevant actions and verify they appear in the security audit log.', endpoints: ['GET /security-audit-log'], expectedBehavior: 'All AUTH_SUCCESS, AUTH_FAIL, ROLE_DENIED, RATE_LIMITED events are logged with correct timestamps', severity: 'high', isoRef: 'A.12.4.1' },
      { id: 'comp-02', title: 'Audit log integrity check (cron)', description: 'Verify the weekly cron job detects gaps in audit log coverage.', endpoints: ['Deno.cron audit-log-integrity-check'], expectedBehavior: 'Missing days flagged as AUDIT_INTEGRITY_WARNING; email sent to alert recipients', severity: 'high', isoRef: 'A.12.4.2' },
      { id: 'comp-03', title: 'Manual integrity check endpoint', description: 'Trigger POST /compliance/run-integrity-check and verify results.', endpoints: ['POST /compliance/run-integrity-check'], expectedBehavior: '200 with health status, gap list, and security event logged', severity: 'medium', isoRef: 'A.12.4.2' },
      { id: 'comp-04', title: 'Data retention policy CRUD', description: 'Read and update retention policy values. Verify range validation.', endpoints: ['GET /retention-policy', 'PUT /retention-policy'], expectedBehavior: 'Values within min/max range accepted; out-of-range rejected with 400', severity: 'medium', isoRef: 'A.18.1.3', pdpaRef: 'PDPA s.10' },
      { id: 'comp-05', title: 'Alert recipients CRUD', description: 'Add, toggle, remove alert recipients. Verify persistence and email validation.', endpoints: ['GET /compliance/alert-recipients', 'PUT /compliance/alert-recipients'], expectedBehavior: 'Recipients saved in KV; invalid emails rejected; ALERT_RECIPIENTS_UPDATED event logged', severity: 'medium' },
      { id: 'comp-06', title: 'Compliance status aggregation', description: 'Verify GET /compliance-status returns correct health status, cron list, and retention info.', endpoints: ['GET /compliance-status'], expectedBehavior: 'Aggregated view with lastCheck, integrityResults, crons, retentionPolicy, alertRecipientsCount', severity: 'low' },
      { id: 'comp-07', title: 'Data retention purge cron', description: 'Verify the daily purge cron respects configured retention windows.', endpoints: ['Deno.cron data-retention-purge'], expectedBehavior: 'Expired records deleted; non-expired records preserved', severity: 'high', isoRef: 'A.18.1.3', pdpaRef: 'PDPA s.10' },
    ],
  },
  {
    id: 'api-security',
    title: 'API Security & Infrastructure',
    description: 'Verify CORS, error handling, logging, and infrastructure-level security controls',
    items: [
      { id: 'api-01', title: 'CORS headers on all responses', description: 'Verify Access-Control-Allow-Origin and related headers are set correctly.', endpoints: ['All endpoints (OPTIONS preflight)'], expectedBehavior: 'Open CORS headers present; preflight requests return 204', severity: 'medium' },
      { id: 'api-02', title: 'Error responses do not leak stack traces', description: 'Trigger server errors and verify response bodies contain safe error messages only.', endpoints: ['All endpoints'], expectedBehavior: 'Error responses include descriptive message but no file paths, line numbers, or stack traces', severity: 'high', isoRef: 'A.14.1.2' },
      { id: 'api-03', title: 'SUPABASE_SERVICE_ROLE_KEY not exposed', description: 'Verify the service role key is never sent to the frontend in any response.', endpoints: ['All endpoints'], expectedBehavior: 'No response body, header, or error message contains the service role key', severity: 'critical', isoRef: 'A.10.1.2' },
      { id: 'api-04', title: 'Request logging via Hono logger', description: 'Verify all requests are logged with method, path, and response status.', endpoints: ['All endpoints'], expectedBehavior: 'Console logs show request details for debugging', severity: 'low' },
      { id: 'api-05', title: 'Auto-publish cron social media posting', description: 'Verify the auto-publish cron correctly publishes scheduled content and handles failures.', endpoints: ['Deno.cron auto-publish-scheduled-cards'], expectedBehavior: 'Scheduled cards published at correct time; failures logged with retry mechanism', severity: 'high' },
      { id: 'api-06', title: 'Storage bucket security (private buckets)', description: 'Verify Supabase Storage buckets are private and files are accessed via signed URLs only.', endpoints: ['Storage operations'], expectedBehavior: 'Direct URL access returns 401; only signed URLs work', severity: 'high', isoRef: 'A.10.1.1' },
    ],
  },
];

// ─── Status display config ────────────────────────────────────────────────────

const STATUS_CONFIG: Record<TestStatus, { label: string; icon: React.ReactNode; cls: string }> = {
  not_tested: { label: 'Not Tested', icon: <HelpCircle className="w-4 h-4" />, cls: 'text-gray-400' },
  pass:       { label: 'Pass',       icon: <CheckCircle2 className="w-4 h-4" />, cls: 'text-emerald-500' },
  fail:       { label: 'Fail',       icon: <XCircle className="w-4 h-4" />, cls: 'text-red-500' },
  partial:    { label: 'Partial',    icon: <AlertTriangle className="w-4 h-4" />, cls: 'text-amber-500' },
  na:         { label: 'N/A',        icon: <Clock className="w-4 h-4" />, cls: 'text-gray-300' },
};

const SEVERITY_CONFIG: Record<Severity, { cls: string }> = {
  critical: { cls: 'bg-red-500/15 text-red-600 border-red-500/25' },
  high:     { cls: 'bg-orange-500/15 text-orange-600 border-orange-500/25' },
  medium:   { cls: 'bg-amber-500/15 text-amber-600 border-amber-500/25' },
  low:      { cls: 'bg-sky-500/15 text-sky-600 border-sky-500/25' },
  info:     { cls: 'bg-gray-500/15 text-gray-600 border-gray-500/25' },
};

// ─── Component ────────────────────────────────────────────────────────────────

export function PenTestChecklist() {
  const t = useDashboardTheme();

  const [results, setResults] = useState<Record<string, TestResult>>(loadResults);
  const [expandedCategories, setExpandedCategories] = useState<Set<string>>(new Set());
  const [expandedItems, setExpandedItems] = useState<Set<string>>(new Set());
  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState<TestStatus | 'all'>('all');
  const [severityFilter, setSeverityFilter] = useState<Severity | 'all'>('all');

  // ── Server sync state ───────────────────────────────────────────────────────
  const [syncing, setSyncing] = useState(false);
  const [loading, setLoading] = useState(true);
  const [lastSyncedAt, setLastSyncedAt] = useState<string | null>(null);
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const serverSnapshotRef = useRef<string>('{}');

  // ── Cached auth headers for emergency save-on-unload ────────────────────────
  // Pre-cached synchronously so the beforeunload handler can fire a keepalive
  // fetch without awaiting async getAuthHeaders(). Updated on every successful
  // server interaction.
  const cachedAuthHeadersRef = useRef<Record<string, string> | null>(null);

  /** Update cached auth headers after any successful server call */
  const cacheCurrentAuthHeaders = useCallback(async () => {
    try {
      const { getAuthHeaders } = await import('../../utils/authHeaders');
      cachedAuthHeadersRef.current = await getAuthHeaders(true);
    } catch { /* best-effort */ }
  }, []);

  // ── Load from server on mount (merge with localStorage cache) ───────────────
  useEffect(() => {
    // Check for emergency-save recovery flag from a prior session
    const emergencySaveAt = localStorage.getItem(LS_EMERGENCY_SAVE_KEY);
    if (emergencySaveAt) {
      localStorage.removeItem(LS_EMERGENCY_SAVE_KEY);
      const when = new Date(emergencySaveAt);
      toast.info(
        `Pen test data was emergency-saved on ${when.toLocaleString()}. Your changes were preserved.`,
        { id: 'pentest-emergency-recovery', duration: 8000 },
      );
    }

    setLoading(true);
    fetchPenTestResults()
      .then(payload => {
        const serverResults = payload.results ?? {};
        const localResults = loadResults();
        // Merge strategy: server wins unless local has a more recent testedAt
        const merged: Record<string, TestResult> = { ...serverResults };
        for (const [id, local] of Object.entries(localResults)) {
          const server = serverResults[id];
          if (!server) {
            merged[id] = local;
          } else if (local.testedAt && server.testedAt && local.testedAt > server.testedAt) {
            merged[id] = local;
          }
        }
        setResults(merged);
        saveResults(merged);
        serverSnapshotRef.current = JSON.stringify(serverResults);
        setLastSyncedAt(payload.updatedAt);
        setHasUnsavedChanges(JSON.stringify(merged) !== JSON.stringify(serverResults));
        cacheCurrentAuthHeaders();
      })
      .catch(err => {
        console.error('[PenTestChecklist] server load error:', err);
        // Fall back to localStorage silently
      })
      .finally(() => setLoading(false));
  }, []);

  // ── Persist on every change ─────────────────────────────────────────────────
  const updateResult = useCallback((itemId: string, update: Partial<TestResult>) => {
    setResults(prev => {
      const current = prev[itemId] || { status: 'not_tested', notes: '' };
      const next = { ...prev, [itemId]: { ...current, ...update, testedAt: new Date().toISOString() } };
      saveResults(next);
      setHasUnsavedChanges(JSON.stringify(next) !== serverSnapshotRef.current);
      return next;
    });
  }, []);

  // ── Save to server ──────────────────────────────────────────────────────────
  const handleSaveToServer = async () => {
    setSyncing(true);
    try {
      const payload = await savePenTestResults(results as Record<string, PenTestResultEntry>);
      serverSnapshotRef.current = JSON.stringify(payload.results);
      setLastSyncedAt(payload.updatedAt);
      setHasUnsavedChanges(false);
      toast.success('Pen test results saved to server');
    } catch (err: any) {
      console.error('[PenTestChecklist] save error:', err);
      toast.error(`Failed to save to server: ${err.message}`);
    } finally {
      setSyncing(false);
      cacheCurrentAuthHeaders(); // Keep emergency-save headers fresh
    }
  };

  // ── Auto-save debounce (30s after last change, visibility-aware) ─────────────
  const autoSaveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const resultsRef = useRef(results);
  resultsRef.current = results;
  const [autoSaveCountdown, setAutoSaveCountdown] = useState<number | null>(null);
  const countdownRef = useRef<ReturnType<typeof setInterval> | null>(null);
  const autoSaveStartRef = useRef<number>(0); // Date.now() when auto-save timer started
  const AUTO_SAVE_DELAY = 30_000;

  /** Recalculate countdown from the true startedAt timestamp (used by visibilitychange) */
  const recalcCountdown = useCallback(() => {
    if (!autoSaveStartRef.current) return;
    const elapsed = Date.now() - autoSaveStartRef.current;
    const remaining = Math.max(0, Math.ceil((AUTO_SAVE_DELAY - elapsed) / 1000));
    setAutoSaveCountdown(remaining);
  }, []);

  useEffect(() => {
    if (!hasUnsavedChanges || loading) {
      setAutoSaveCountdown(null);
      autoSaveStartRef.current = 0;
      if (countdownRef.current) { clearInterval(countdownRef.current); countdownRef.current = null; }
      return;
    }

    // Clear any existing timers
    if (autoSaveTimerRef.current) clearTimeout(autoSaveTimerRef.current);
    if (countdownRef.current) clearInterval(countdownRef.current);

    // Start countdown from 30
    const startedAt = Date.now();
    autoSaveStartRef.current = startedAt;
    setAutoSaveCountdown(30);

    countdownRef.current = setInterval(() => {
      const elapsed = Date.now() - startedAt;
      const remaining = Math.max(0, Math.ceil((AUTO_SAVE_DELAY - elapsed) / 1000));
      setAutoSaveCountdown(remaining);
      if (remaining <= 0 && countdownRef.current) {
        clearInterval(countdownRef.current);
        countdownRef.current = null;
      }
    }, 1000);

    autoSaveTimerRef.current = setTimeout(async () => {
      try {
        const payload = await savePenTestResults(resultsRef.current as Record<string, PenTestResultEntry>);
        serverSnapshotRef.current = JSON.stringify(payload.results);
        setLastSyncedAt(payload.updatedAt);
        setHasUnsavedChanges(false);
        toast.success('Pen test results auto-saved', { id: 'pentest-autosave' });
        cacheCurrentAuthHeaders();
      } catch (err: any) {
        console.error('[PenTestChecklist] auto-save error:', err);
        // Silent failure — user can still manually save
      }
    }, AUTO_SAVE_DELAY);

    return () => {
      if (autoSaveTimerRef.current) clearTimeout(autoSaveTimerRef.current);
      if (countdownRef.current) { clearInterval(countdownRef.current); countdownRef.current = null; }
    };
  }, [hasUnsavedChanges, loading, results]);

  // ── Visibility-aware countdown correction ───────────────────────────────────
  // Browsers throttle timers in background tabs (setInterval may fire ≤1/min).
  // When the tab becomes visible again, immediately recalculate the countdown
  // so the display isn't stale for up to 1 second.
  useEffect(() => {
    const onVisibility = () => {
      if (document.visibilityState === 'visible' && autoSaveStartRef.current) {
        recalcCountdown();
      }
    };
    document.addEventListener('visibilitychange', onVisibility);
    return () => document.removeEventListener('visibilitychange', onVisibility);
  }, [recalcCountdown]);

  // ── Warn on navigate-away with unsaved changes + emergency save ─────────────
  useEffect(() => {
    if (!hasUnsavedChanges) return;
    const handler = (e: BeforeUnloadEvent) => {
      e.preventDefault();
      e.returnValue = 'You have unsaved pen test changes. Leave anyway?';

      // Emergency best-effort save via keepalive fetch.
      // Uses pre-cached auth headers (synchronous) so this works inside
      // the synchronous beforeunload handler. Data is also in localStorage
      // so nothing is truly lost — this just syncs to the server.
      const headers = cachedAuthHeadersRef.current;
      if (headers) {
        try {
          fetch(PENTEST_SAVE_URL, {
            method: 'PUT',
            headers,
            body: JSON.stringify({ results: resultsRef.current }),
            keepalive: true, // Survives page unload
          });
          // Mark that an emergency save was attempted — on next visit we'll
          // show a recovery toast confirming the data was preserved.
          localStorage.setItem(LS_EMERGENCY_SAVE_KEY, new Date().toISOString());
          console.log('[PenTestChecklist] Emergency save fired via keepalive fetch');
        } catch {
          // Best-effort — data is safe in localStorage regardless
        }
      }
    };
    window.addEventListener('beforeunload', handler);
    return () => window.removeEventListener('beforeunload', handler);
  }, [hasUnsavedChanges]);

  // ── Refresh from server ─────────────────────────────────────────────────────
  const handleRefreshFromServer = async () => {
    setSyncing(true);
    try {
      const payload = await fetchPenTestResults();
      const serverResults = payload.results ?? {};
      setResults(serverResults as Record<string, TestResult>);
      saveResults(serverResults as Record<string, TestResult>);
      serverSnapshotRef.current = JSON.stringify(serverResults);
      setLastSyncedAt(payload.updatedAt);
      setHasUnsavedChanges(false);
      toast.success('Loaded latest results from server');
    } catch (err: any) {
      console.error('[PenTestChecklist] refresh error:', err);
      toast.error(`Failed to refresh: ${err.message}`);
    } finally {
      setSyncing(false);
    }
  };

  // ── Stats ───────────────────────────────────────────────────────────────────
  const allItems = useMemo(() => CATEGORIES.flatMap(c => c.items), []);
  const totalItems = allItems.length;
  const stats = useMemo(() => {
    const s = { pass: 0, fail: 0, partial: 0, not_tested: 0, na: 0 };
    for (const item of allItems) {
      const r = results[item.id];
      s[r?.status || 'not_tested']++;
    }
    return s;
  }, [results, allItems]);

  const completionPct = Math.round(((stats.pass + stats.fail + stats.partial + stats.na) / totalItems) * 100);

  // ── Filtering ───────────────────────────────────────────────────────────────
  const filteredCategories = useMemo(() => {
    return CATEGORIES.map(cat => {
      const filtered = cat.items.filter(item => {
        if (searchQuery) {
          const q = searchQuery.toLowerCase();
          const matchText = (item.title + item.description + item.endpoints.join(' ')).toLowerCase().includes(q);
          if (!matchText) return false;
        }
        if (statusFilter !== 'all') {
          const r = results[item.id];
          if ((r?.status || 'not_tested') !== statusFilter) return false;
        }
        if (severityFilter !== 'all') {
          if (item.severity !== severityFilter) return false;
        }
        return true;
      });
      return { ...cat, items: filtered };
    }).filter(cat => cat.items.length > 0);
  }, [searchQuery, statusFilter, severityFilter, results]);

  // ── Toggle helpers ──────────────────────────────────────────────────────────
  const toggleCategory = (id: string) => {
    setExpandedCategories(prev => {
      const next = new Set(prev);
      next.has(id) ? next.delete(id) : next.add(id);
      return next;
    });
  };

  const toggleItem = (id: string) => {
    setExpandedItems(prev => {
      const next = new Set(prev);
      next.has(id) ? next.delete(id) : next.add(id);
      return next;
    });
  };

  // ── CSV export ──────────────────────────────────────────────────────────────
  const handleExportCsv = () => {
    const escape = (s: string) => `"${String(s ?? '').replace(/"/g, '""')}"`;
    const headers = ['Category', 'ID', 'Title', 'Severity', 'Status', 'Notes', 'Endpoints', 'Expected Behavior', 'ISO Ref', 'PDPA Ref', 'Tested At'];
    const rows: string[][] = [];
    for (const cat of CATEGORIES) {
      for (const item of cat.items) {
        const r = results[item.id];
        rows.push([
          cat.title, item.id, item.title, item.severity,
          r?.status || 'not_tested', r?.notes || '',
          item.endpoints.join('; '), item.expectedBehavior,
          item.isoRef || '', item.pdpaRef || '', r?.testedAt || '',
        ]);
      }
    }
    const csv = [headers.map(escape).join(','), ...rows.map(r => r.map(escape).join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pentest-checklist-${new Date().toISOString().slice(0, 10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    toast.success('Pen test checklist exported as CSV');
  };

  // ── Reset all ───────────────────────────────────────────────────────────────
  const handleReset = async () => {
    if (!confirm('Reset all test results? This cannot be undone.')) return;
    setResults({});
    saveResults({});
    serverSnapshotRef.current = '{}';
    setHasUnsavedChanges(false);
    // Best-effort server reset
    try {
      const payload = await savePenTestResults({});
      setLastSyncedAt(payload.updatedAt);
    } catch (err: any) {
      console.error('[PenTestChecklist] server reset error:', err);
    }
    toast.info('All test results have been reset');
  };

  // ── Expand / collapse all ───────────────────────────────────────────────────
  const expandAll = () => setExpandedCategories(new Set(CATEGORIES.map(c => c.id)));
  const collapseAll = () => { setExpandedCategories(new Set()); setExpandedItems(new Set()); };

  // ── Styles ──────────────────────────────────────────────────────────────────
  const selectCls = `rounded-lg border px-2.5 py-1.5 text-xs font-medium transition-all focus:outline-none ${
    t.isDark ? 'bg-white/5 border-white/15 text-white/80' : 'bg-white border-gray-200 text-gray-700'
  }`;

  return (
    <>
      {/* Summary banner */}
      <div className={`rounded-2xl border p-5 mb-6 ${t.isDark ? 'bg-white/5 border-white/10' : 'bg-white border-gray-200'}`}>
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h3 className={`${t.text} text-lg font-bold flex items-center gap-2`}>
              <ShieldCheck className="w-5 h-5" style={{ color: '#0BA4AA' }} />
              Penetration Test Checklist
            </h3>
            <p className={`${t.textFaint} text-xs mt-1`}>
              {totalItems} test cases across {CATEGORIES.length} categories · {completionPct}% assessed
            </p>
          </div>
          <div className="flex items-center gap-2 flex-wrap">
            <PrimaryBtn variant="ghost" onClick={handleSaveToServer} disabled={syncing || !hasUnsavedChanges}>
              {syncing ? <Loader2 className="w-4 h-4 animate-spin" /> : <CloudUpload className="w-4 h-4" />}
              {syncing ? 'Saving…' : 'Save to Server'}
            </PrimaryBtn>
            <PrimaryBtn variant="ghost" onClick={handleRefreshFromServer} disabled={syncing}>
              <RefreshCw className={`w-4 h-4 ${syncing ? 'animate-spin' : ''}`} /> Refresh
            </PrimaryBtn>
            <PrimaryBtn variant="ghost" onClick={handleExportCsv}>
              <Download className="w-4 h-4" /> Export CSV
            </PrimaryBtn>
            <PrimaryBtn variant="ghost" onClick={handleReset}>
              <RotateCcw className="w-4 h-4" /> Reset
            </PrimaryBtn>
          </div>
        </div>

        {/* Sync status bar */}
        <div className={`flex items-center gap-2 mt-3 text-xs ${t.textFaint}`}>
          {/* Cloud icon with radial countdown ring when auto-save is pending */}
          {hasUnsavedChanges && autoSaveCountdown != null && autoSaveCountdown > 0 ? (
            <div className="relative w-5 h-5 shrink-0 flex items-center justify-center">
              <svg className="absolute inset-0 -rotate-90" viewBox="0 0 20 20" fill="none">
                {/* Background track */}
                <circle cx="10" cy="10" r="8" strokeWidth="1.5"
                  className={t.isDark ? 'stroke-white/10' : 'stroke-gray-200'} />
                {/* Countdown arc — depletes as time passes */}
                <circle cx="10" cy="10" r="8" strokeWidth="1.5"
                  strokeLinecap="round"
                  stroke="#F59E0B"
                  strokeDasharray={`${2 * Math.PI * 8}`}
                  strokeDashoffset={`${2 * Math.PI * 8 * (1 - autoSaveCountdown / 30)}`}
                  style={{ transition: 'stroke-dashoffset 1s linear' }}
                />
              </svg>
              <Cloud className="w-2.5 h-2.5 text-amber-500" />
            </div>
          ) : hasUnsavedChanges && autoSaveCountdown != null && autoSaveCountdown <= 0 ? (
            <Loader2 className="w-3.5 h-3.5 animate-spin text-amber-500 shrink-0" />
          ) : (
            <Cloud className="w-3.5 h-3.5" />
          )}
          {lastSyncedAt ? (
            <span>Last synced: <strong className={t.textMd}>{new Date(lastSyncedAt).toLocaleString()}</strong></span>
          ) : (
            <span>Not yet synced to server</span>
          )}
          {hasUnsavedChanges && (
            <>
              <span className={`ml-2 text-[0.6rem] font-bold px-2 py-0.5 rounded-full border ${
                t.isDark ? 'bg-amber-500/15 text-amber-400 border-amber-500/25' : 'bg-amber-50 text-amber-600 border-amber-200'
              }`}>
                UNSAVED CHANGES
              </span>
              <span className={`text-[0.6rem] ${t.textFaint}`}>
                · {autoSaveCountdown != null && autoSaveCountdown > 0
                    ? `auto-saves in ${autoSaveCountdown}s`
                    : 'auto-saving…'}
              </span>
            </>
          )}
        </div>

        {/* Progress bar */}
        <div className="mt-4">
          <div className={`h-3 rounded-full overflow-hidden flex ${t.isDark ? 'bg-white/10' : 'bg-gray-100'}`}>
            {stats.pass > 0 && <div className="bg-emerald-500 transition-all" style={{ width: `${(stats.pass / totalItems) * 100}%` }} />}
            {stats.partial > 0 && <div className="bg-amber-500 transition-all" style={{ width: `${(stats.partial / totalItems) * 100}%` }} />}
            {stats.fail > 0 && <div className="bg-red-500 transition-all" style={{ width: `${(stats.fail / totalItems) * 100}%` }} />}
            {stats.na > 0 && <div className={`${t.isDark ? 'bg-white/20' : 'bg-gray-300'} transition-all`} style={{ width: `${(stats.na / totalItems) * 100}%` }} />}
          </div>
        </div>

        {/* Stat chips */}
        <div className="flex flex-wrap gap-3 mt-3">
          {([
            ['pass', stats.pass, 'bg-emerald-500/15 text-emerald-600 border-emerald-500/25'],
            ['partial', stats.partial, 'bg-amber-500/15 text-amber-600 border-amber-500/25'],
            ['fail', stats.fail, 'bg-red-500/15 text-red-600 border-red-500/25'],
            ['not_tested', stats.not_tested, t.isDark ? 'bg-white/5 border-white/15 text-white/50' : 'bg-gray-50 border-gray-200 text-gray-500'],
            ['na', stats.na, t.isDark ? 'bg-white/5 border-white/10 text-white/30' : 'bg-gray-50 border-gray-200 text-gray-400'],
          ] as const).map(([key, count, cls]) => (
            <button key={key} onClick={() => setStatusFilter(statusFilter === key ? 'all' : key as TestStatus)}
              className={`flex items-center gap-1.5 px-2.5 py-1 rounded-full border text-xs font-semibold transition-all ${cls} ${statusFilter === key ? 'ring-2 ring-offset-1 ring-current' : ''}`}
            >
              {STATUS_CONFIG[key as TestStatus].icon}
              {count} {STATUS_CONFIG[key as TestStatus].label}
            </button>
          ))}
        </div>
      </div>

      {/* Search & filters */}
      <div className="flex flex-col sm:flex-row gap-3 mb-6">
        <div className="relative flex-1">
          <Search className={`absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 ${t.textFaint}`} />
          <input
            type="text" value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
            placeholder="Search test cases…"
            className={`w-full pl-9 pr-4 py-2 rounded-xl border text-sm focus:outline-none transition-all ${
              t.isDark ? 'bg-white/5 border-white/15 text-white placeholder-white/30' : 'bg-white border-gray-200 text-gray-900 placeholder-gray-400'
            }`}
          />
        </div>
        <div className="flex gap-2">
          <div className="flex items-center gap-1.5">
            <Filter className={`w-3.5 h-3.5 ${t.textFaint}`} />
            <select value={severityFilter} onChange={e => setSeverityFilter(e.target.value as any)} className={selectCls}>
              <option value="all">All Severities</option>
              <option value="critical">Critical</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <button onClick={expandAll} className={`text-xs ${t.textFaint} hover:${t.text} transition-colors px-2`}>Expand All</button>
          <button onClick={collapseAll} className={`text-xs ${t.textFaint} hover:${t.text} transition-colors px-2`}>Collapse All</button>
        </div>
      </div>

      {/* Categories */}
      {filteredCategories.length === 0 ? (
        <Card>
          <div className="flex flex-col items-center justify-center py-16 gap-3">
            <Search className={`w-10 h-10 ${t.textFaint}`} />
            <p className={`${t.text} font-medium`}>No test cases match your filters</p>
            <p className={`${t.textFaint} text-sm`}>Try adjusting your search or filter criteria</p>
          </div>
        </Card>
      ) : (
        <div className="space-y-4">
          {filteredCategories.map(cat => {
            const isExpanded = expandedCategories.has(cat.id);
            const catStats = { pass: 0, fail: 0, partial: 0, total: cat.items.length };
            cat.items.forEach(item => {
              const s = results[item.id]?.status;
              if (s === 'pass') catStats.pass++;
              if (s === 'fail') catStats.fail++;
              if (s === 'partial') catStats.partial++;
            });

            return (
              <div key={cat.id} className={`rounded-2xl border overflow-hidden ${t.s0} ${t.border}`}>
                {/* Category header */}
                <button
                  onClick={() => toggleCategory(cat.id)}
                  className={`w-full flex items-center gap-3 px-5 py-4 text-left transition-colors ${
                    t.isDark ? 'hover:bg-white/5' : 'hover:bg-gray-50'
                  }`}
                >
                  {isExpanded
                    ? <ChevronDown className={`w-5 h-5 shrink-0 ${t.textFaint}`} />
                    : <ChevronRight className={`w-5 h-5 shrink-0 ${t.textFaint}`} />}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 flex-wrap">
                      <span className={`${t.text} font-semibold text-sm`}>{cat.title}</span>
                      <span className={`text-[0.6rem] font-medium px-2 py-0.5 rounded-full border ${
                        t.isDark ? 'border-white/15 text-white/40' : 'border-gray-200 text-gray-400'
                      }`}>{cat.items.length} tests</span>
                    </div>
                    <p className={`${t.textFaint} text-xs mt-0.5`}>{cat.description}</p>
                  </div>
                  {/* Mini stats */}
                  <div className="flex items-center gap-2 shrink-0">
                    {catStats.pass > 0 && <span className="flex items-center gap-0.5 text-emerald-500 text-xs font-bold"><CheckCircle2 className="w-3.5 h-3.5" />{catStats.pass}</span>}
                    {catStats.fail > 0 && <span className="flex items-center gap-0.5 text-red-500 text-xs font-bold"><XCircle className="w-3.5 h-3.5" />{catStats.fail}</span>}
                    {catStats.partial > 0 && <span className="flex items-center gap-0.5 text-amber-500 text-xs font-bold"><AlertTriangle className="w-3.5 h-3.5" />{catStats.partial}</span>}
                  </div>
                </button>

                {/* Items */}
                <AnimatePresence>
                  {isExpanded && (
                    <motion.div
                      initial={{ height: 0 }} animate={{ height: 'auto' }} exit={{ height: 0 }}
                      className="overflow-hidden"
                    >
                      <div className={`border-t ${t.border}`}>
                        {cat.items.map(item => {
                          const r = results[item.id] || { status: 'not_tested', notes: '' };
                          const isItemExpanded = expandedItems.has(item.id);
                          const sc = STATUS_CONFIG[r.status];

                          return (
                            <div key={item.id} className={`border-b last:border-b-0 ${t.border}`}>
                              {/* Item row */}
                              <div className={`flex items-center gap-3 px-5 py-3 ${t.isDark ? 'hover:bg-white/3' : 'hover:bg-gray-50/50'}`}>
                                {/* Status selector */}
                                <select
                                  value={r.status}
                                  onChange={e => updateResult(item.id, { status: e.target.value as TestStatus })}
                                  className={`rounded-lg border px-2 py-1 text-xs font-semibold focus:outline-none w-24 shrink-0 ${
                                    r.status === 'pass' ? 'bg-emerald-500/15 border-emerald-500/25 text-emerald-600' :
                                    r.status === 'fail' ? 'bg-red-500/15 border-red-500/25 text-red-600' :
                                    r.status === 'partial' ? 'bg-amber-500/15 border-amber-500/25 text-amber-600' :
                                    r.status === 'na' ? (t.isDark ? 'bg-white/5 border-white/10 text-white/30' : 'bg-gray-50 border-gray-200 text-gray-400') :
                                    (t.isDark ? 'bg-white/5 border-white/15 text-white/50' : 'bg-gray-50 border-gray-200 text-gray-500')
                                  }`}
                                >
                                  <option value="not_tested">Not Tested</option>
                                  <option value="pass">Pass</option>
                                  <option value="fail">Fail</option>
                                  <option value="partial">Partial</option>
                                  <option value="na">N/A</option>
                                </select>

                                {/* Title + severity */}
                                <button onClick={() => toggleItem(item.id)} className="flex-1 min-w-0 text-left">
                                  <div className="flex items-center gap-2">
                                    <span className={`${t.text} text-sm font-medium truncate`}>{item.title}</span>
                                    <span className={`text-[0.55rem] font-bold px-1.5 py-0.5 rounded-full border uppercase ${SEVERITY_CONFIG[item.severity].cls}`}>
                                      {item.severity}
                                    </span>
                                    {item.isoRef && (
                                      <span className={`text-[0.55rem] font-mono px-1.5 py-0.5 rounded-full ${
                                        t.isDark ? 'bg-purple-500/10 text-purple-400' : 'bg-purple-50 text-purple-600'
                                      }`}>{item.isoRef}</span>
                                    )}
                                  </div>
                                </button>

                                {/* Expand arrow */}
                                <button onClick={() => toggleItem(item.id)} className={`${t.textFaint} shrink-0`}>
                                  {isItemExpanded ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
                                </button>
                              </div>

                              {/* Expanded detail */}
                              <AnimatePresence>
                                {isItemExpanded && (
                                  <motion.div
                                    initial={{ height: 0, opacity: 0 }} animate={{ height: 'auto', opacity: 1 }} exit={{ height: 0, opacity: 0 }}
                                    className="overflow-hidden"
                                  >
                                    <div className={`px-5 pb-4 space-y-3 ml-[6.5rem]`}>
                                      {/* Description */}
                                      <p className={`${t.textMd} text-xs leading-relaxed`}>{item.description}</p>

                                      {/* Endpoints */}
                                      <div>
                                        <span className={`text-[0.6rem] font-bold uppercase tracking-wider ${t.textFaint}`}>Endpoints</span>
                                        <div className="flex flex-wrap gap-1.5 mt-1">
                                          {item.endpoints.map(ep => (
                                            <code key={ep} className={`text-[0.65rem] font-mono px-2 py-0.5 rounded ${
                                              t.isDark ? 'bg-white/5 text-teal-400' : 'bg-teal-50 text-teal-700'
                                            }`}>{ep}</code>
                                          ))}
                                        </div>
                                      </div>

                                      {/* Expected behavior */}
                                      <div>
                                        <span className={`text-[0.6rem] font-bold uppercase tracking-wider ${t.textFaint}`}>Expected Behavior</span>
                                        <p className={`${t.textMd} text-xs mt-1`}>{item.expectedBehavior}</p>
                                      </div>

                                      {/* References */}
                                      {(item.isoRef || item.pdpaRef) && (
                                        <div className="flex gap-3">
                                          {item.isoRef && (
                                            <div className="flex items-center gap-1">
                                              <Info className={`w-3 h-3 ${t.textFaint}`} />
                                              <span className={`text-[0.6rem] font-mono ${t.isDark ? 'text-purple-400' : 'text-purple-600'}`}>ISO 27001 {item.isoRef}</span>
                                            </div>
                                          )}
                                          {item.pdpaRef && (
                                            <div className="flex items-center gap-1">
                                              <Info className={`w-3 h-3 ${t.textFaint}`} />
                                              <span className={`text-[0.6rem] font-mono ${t.isDark ? 'text-orange-400' : 'text-orange-600'}`}>{item.pdpaRef}</span>
                                            </div>
                                          )}
                                        </div>
                                      )}

                                      {/* Notes */}
                                      <div>
                                        <span className={`text-[0.6rem] font-bold uppercase tracking-wider ${t.textFaint}`}>Tester Notes</span>
                                        <textarea
                                          value={r.notes}
                                          onChange={e => updateResult(item.id, { notes: e.target.value })}
                                          placeholder="Add notes, findings, screenshots links…"
                                          rows={2}
                                          className={`w-full mt-1 rounded-xl border px-3 py-2 text-xs focus:outline-none transition-all resize-y ${
                                            t.isDark ? 'bg-white/5 border-white/15 text-white placeholder-white/30' : 'bg-white border-gray-200 text-gray-900 placeholder-gray-400'
                                          }`}
                                        />
                                      </div>

                                      {/* Tested at */}
                                      {r.testedAt && (
                                        <p className={`${t.textFaint} text-[0.6rem] font-mono`}>
                                          Last tested: {new Date(r.testedAt).toLocaleString()}
                                        </p>
                                      )}
                                    </div>
                                  </motion.div>
                                )}
                              </AnimatePresence>
                            </div>
                          );
                        })}
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>
            );
          })}
        </div>
      )}

      {/* Footer */}
      <div className={`mt-6 flex items-start gap-2.5 p-3 rounded-xl border text-xs ${
        t.isDark ? 'bg-sky-500/5 border-sky-500/20 text-sky-400' : 'bg-sky-50 border-sky-200 text-sky-700'
      }`}>
        <Info className="w-4 h-4 shrink-0 mt-0.5" />
        <div>
          <strong>Testing Guidance:</strong> This checklist covers all Phase 1–6 security controls. For each test case, set the status to Pass/Fail/Partial after testing and add detailed notes. Export as CSV for external auditor handoff. Test results are stored locally and persist across sessions. ISO 27001 and PDPA references are indicated where applicable.
        </div>
      </div>
    </>
  );
}